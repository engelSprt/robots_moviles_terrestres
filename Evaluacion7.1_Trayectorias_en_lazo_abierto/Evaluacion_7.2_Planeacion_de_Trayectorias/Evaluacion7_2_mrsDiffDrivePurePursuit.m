%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1;               % Sample time [s]
tVec = 0:sampleTime:129.7;         % Time array

initPose = [4.7176457734249;4.3336689728819;0];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
%waypoints = [5,1; 4,2; 3,3; 3,4; 3,5; 4,6; 5,7; 6,7; 7,7 ; 8,6; 7,5; 6,6; 7,5; 8,5; 7,5; 8,6; 10,9; 9,10; 8,11; 6,11; 5,10; 4,9; 10,9; 8,6; 9,5; 9,3; 8,2; 7,1; 5,1];

waypoints = [4.7176457734249,4.3336689728819;
             4.7392407246588,4.1717068386278;
             4.7716331515096,3.9881497531398;
             4.8148230539774,3.7182128627163;
             4.8631958559107,3.5164541595177;
             4.948680877875,3.2801132164399;
             5.0291373691356,3.0940575804;
             5.134736513915,2.9381731285827;
             5.2604497815096,2.8174883916919;
             5.436448356142,2.7068607162087;
             5.6174754614781,2.6213756942444;
             5.8839875887786,2.5208050801687;
             6.2158706152282,2.4856053652423;
             6.5829533566044,2.5710903872066;
             6.7086666241989,2.6213756942444;
             6.8997507909427,2.7571460232465;
             7.0606637734637,2.8728022294335;
             7.1964341024658,3.0538293347697;
             7.2869476551339,3.2700561550323;
             7.3372329621718,3.4410261989609;
             7.3975753306171,3.6119962428896;
             7.4277465148398,3.7678806947068;
             7.4428321069512,3.9036510237089;
             7.4629462297663,4.0746210676375;
             7.4981459446928,4.2556481729737;
             7.5031744753966,4.3863899712721;
             
             7.4428321069512, 3.9036510237089;
             7.4629462297663, 4.0746210676375;
             7.4981459446928, 4.2556481729737;
             7.5031744753966, 4.3863899712721;
             7.5123172584944, 4.5646742416789;
             7.5077458669455, 4.7109587712435;
             7.5045413409296, 4.8624962887165;
             7.5, 5;
             7.4408030716873, 5.218368291986;
             7.3876878473187, 5.3564678753444;
             7.339884145387, 5.5370596381976;
             7.2602113088341, 5.7229629234876;
             7.1911615171549, 5.8716855517196;
                7.1061771581652, 5.9354238209619;
                7, 6;
                6.8777816933803, 6.1107040613783;
                6.739682110022, 6.1744423306206;
                6.6387631837217, 6.1638192857469
                6.5325327349845 6.1478847184363;
                6.4050561964999, 6.1266386286889;
                6.2563335682679, 6.1000810165046;
                6.0757418054147, 6.1319501511257;
                5.9907574464249, 6.15850776331;
                6.1660376868413, 6.1107040613783;


                5.9217076547458, 6.2063114652417;
                5.836723295756, 6.2381805998629;
                5.7517389367663, 6.2434921222997;
                5.6614430553397, 6.2434921222997;
                5.5233434719814, 6.2434921222997;
                5.4011784559336, 6.2275575549892;
                5.2790134398859, 6.2009999428049;
                5.1834060360224, 6.1478847184363;
                5.1037331994696, 6.1000810165046;
                5, 6;
                4.9709451385481, 5.9141777312145;
                4.9550105712375, 5.8185703273511;
                4.9231414366164, 5.7335859683613;
                4.8806492571215, 5.595486385003;
                4.8700262122478, 5.4680098465184;
                4.8222225103161, 5.3617793977812;
                4.7691072859475, 5.2449259041703;
                4.7584842410738, 5.1493185003069;
                4.7266151064526, 5.0165304393854;
                4.7159920615789, 4.9049884682114;
                4.710680539142, 4.7881349746005;
                4.6947459718314, 4.6819045258633;
                4.6947459718314, 4.5650510322525
                4.7000574942683, 4.4535090610784;

                4.7584842410738, 4.0817024904983;
                4.6681883596472, 4.2251135962935;
                4.6310077025891, 4.3366555674675;
                4.6044500904049, 4.4853781956996;
                4.5885155230943, 4.6022316893105;
                4.5354002987257, 4.7668888848531;
                4.5, 5;
                4.4610389846097, 5.1705645900543;
                4.4451044172991, 5.3670909202181;
                4.4929081192308, 5.5742402952556;
                4.5194657314151, 5.7495205356719;
                4.5, 6;
                4.5778924782206, 6.1638192857469;
                4.636319225026, 6.3337880037263;
                4.7645071720901, 6.5221535442162;
                4.8698341126484, 6.66434491397;
                5.0383572175417, 6.8012699366958;
                5.2437447516305, 6.8960641831983;
                5.3754034273284, 7.038255552952;
                5.5439265322217, 7.0961853702591;
                5.6439871257521, 7.1067180643149;
                5.8019775365896, 7.1067180643149;
                5.9441689063433, 7.1383161464824;
                6.1074256642087, 7.164647881622;

                6.1074256642087, 7.164647881622;
                6.2127526047671, 7.164647881622;
                6.2970141572137, 7.1488488405383;
                6.4234064858837, 7.1119844113428;
                6.5445324675258, 7.1119844113428;
                6.6761911432237, 7.0961853702591;
                6.8236488600054, 7.0645872880916;
                6.9237094535358, 7.0277228588962;
                7, 7;
                7.1080315995128, 6.9434613064495;
                7.1975594989874, 6.8434007129191;
                7.2765547044062, 6.7380737723608;
                7.3713489509086, 6.6327468318025;
                7.4292787682157, 6.5537516263837;
                7.5, 6.5;
                7.5293393617461, 6.3799621744625;
                7.6241336082486, 6.2483034987646;
                7.6715307314999, 6.15877559929;
                7.6978624666395, 6.0376496176479;
                7.6767970785278, 5.9428553711454;
                7.6715307314999, 5.8217293895033;
                7.6767970785278, 5.716402448945;
                7.6873297725836, 5.6216082024425;
                7.6820634255557, 5.5215476089121;
                7.6820634255557, 5.4214870153817;

                7.7112812136958, 5.296441455559;
                7.716124577793, 5.1656706249354;
                7.68706439321, 5.0542732507005;
                7.6676909368213, 4.9574059687571;
                7.6386307522383, 4.8121050458421;
                7.6192572958496, 4.7200811279958;
                7.6192572958496, 4.5311899282062;
                7.4933298293232, 4.7733581330647;
                7.4836431011289, 4.9331891482713;
                7.4739563729345, 5.0930201634779;
                7.4061492755742, 5.1511405326439;
                7.317802291813, 5.2731522215036;
                7.2351002206231, 5.3723947069316;
                7.1523981494331, 5.4319401981884;
                7.0961607410239, 5.4683291095119;
                7.0266910012244, 5.4749452752071;
                6.9208323501012, 5.4749452752071;
                6.8215898646732, 5.4550967781215;
                6.6826503850741, 5.4286321153408;
                6.4808573313706, 5.369086624084;
                6.4378522543518, 5.3426219613032;
                6.4047714258758, 5.2599198901132;
                6.4345441715042, 5.2102986473992;
                6.5304785740845, 5.2102986473992;

                6.6363372252077, 5.2632279729608;
                6.7355797106357, 5.2896926357416;
           
                6.9274485157964, 5.2930007185892;
                7.0432314154623, 5.269844138656;
                7.1160092381095, 5.2400713930276;
                7.2, 5.2;
                7.2681810490991, 5.203682481704;
                7.3211103746606, 5.2003743988564;
                7.3111861261178, 5.1375208247521;
                7.2582568005563, 5.0349702564765;
                7.2152517235375, 4.9688085995245;
                7.1689385636711, 4.8993388597249;
                7.1160092381095, 4.8993388597249;
                7.0564637468527, 4.8728741969442;
                6.9737616756628, 4.8530256998586;
                6.9109081015584, 4.8464095341634;
                6.7918171190448, 4.8397933684682;
                6.6727261365313, 4.8563337827062;
                6.5900240653413, 4.8728741969442;
                6.4841654142182, 4.8927226940298;
                6.5292685159961, 4.9680525192809;
                6.6, 5;
                6.6928818877916, 5.0356319554573;

                %A7
                6.7675749488287, 5.053416017609;
                6.8351543850052, 5.053416017609;
                6.8831713528147, 5.0463023927484;
                6.9578644138518, 5.021404705736;
                7.0147734127372, 4.9965070187236;
                7.0503415370406, 4.9733877379264;
                7.0930232862047, 4.937819613623;
                7.1002352347996, 4.8863981847482;
                7.0121006495186, 4.8705791566208;
                6.942044953526, 4.8536301979129;
                6.8437409930203, 4.8457206838492;
                6.7556064077392, 4.8547601284934;
                6.7183186985819, 4.8626696425571;
                6.6380936273645, 4.8750988789429;
                6.5443093891809, 4.8841383235871;
                6.5138012635067, 4.8863981847482;
                6.3757923005587, 4.8512570262077;
                6.3670999372952, 4.7121792139929;
                6.4, 4.6;
                6.4236002985075, 4.5035624956706;
                6.4801006597198, 4.4470621344584;
                6.5235624760369, 4.377523228351;
                6.5583319290906, 4.3079843222436;
                6.5713704739857, 4.225406871241;

                6.4844468413515, 4.1471756018702;
                6.4105617536124, 4.1124061488165;
                6.3019072128195, 4.1254446937116;
                6.2323683067121, 4.1471756018702;
                6.128059947551, 4.1124061488165;
                6.0367901332851, 4.1602141467653;
                5.9672512271776, 4.1558679651336;
                5.9064046843337, 4.1210985120799;
                5.810788688436, 4.1080599671848;
                5.7325574190651, 4.1689065100287;
                5.689095602748, 4.2601763242947;
                5.71951887417, 4.3905617732461;
                5.8368657782263, 4.4514083160901;
                5.8585966863848, 4.573101401778;
                5.9411741373874, 4.7165253956246;
                5.9585588639142, 4.846910844576;
                5.7890577802774, 4.9077573874199;
                5.6798311061919, 4.8809379427557;
                5.6098931559099, 4.8542949140768;
                5.5332944484581, 4.8343126425677;
                5.4888492817792, 4.8412117794142;
                5.4428164623381, 4.828424885125;
                5.3865541274656, 4.8412117794142;


                5.284258973152, 4.8642281891348;
                5.2305540171374, 4.877015083424;
                5.1436031359708, 4.8744577045661;
                5.1384883782551, 4.9179331451494;
                5.1901449516282, 4.9609620893027
                5.2594901409492, 5.0007986874233;
                5.3155564642301, 5.0214547012636;
                5.3661716055506, 5.0472380389649;
                5.4184570384639, 5.0581815016677;
                5.4695265310769, 5.0618293225686;
                5.5278916654917, 5.0630452628689;
                5.5886886805071, 5.0423742777637;
                5.6348944119189, 5.0253511135593;
                5.6592132179251, 5.0131917105563;
                5.6823160836309, 4.9961685463519
                5.7175783523399, 4.9742816209464;
                5.7431130986464, 4.9560425164417;
                5.7662159643523, 4.9365874716368;
                5.8618258311534, 5.0402477119631;
                5.91541135055, 5.1659675843936;
                5.9504480363093, 5.250467826519;
                5.9298382211568, 5.3122972719766;
                5.8597648496382, 5.3535169022817;
                5.7711426444823, 5.3823706434952;


                5.6825204393264, 5.4112243847087;
                5.6371788459908, 5.4153463477393;
                5.5691664559874, 5.4318341998613;
                5.4826052323468, 5.4586269595596;
                5.4042879347672, 5.4812977562274;
                5.3507024153706, 5.4833587377426;
                5.2723851177909, 5.4792367747121;
                5.2105556723333, 5.4730538301664;
                5.150787208391, 5.4545049965291;
                5.0889577629334, 5.421529292285;
                5.0477381326283, 5.3823706434952;
                5.0147624283842, 5.3493949392511;
                4.9776647611097, 5.3122972719766;
                4.9426280753504, 5.2813825492478;
                4.9364451308046, 5.242223900458;
                5.0128813630113, 5.2373204335293;
                5.0843068905974, 5.2575576663454;
                5.168827098241, 5.2754140482419;
                5.261680284103, 5.2789853246212;
                5.3569143208845, 5.2742236227822;
                5.4200068702523, 5.2658906445638;
                5.4878611214591, 5.2623193681845;
                5.5390494162292, 5.2516055390465;
                5.6401130696083, 5.2397505414379;


                5.7207805257969, 5.2173137513117;
                5.7781656948015, 5.2038113586048;
                5.8473654574246, 5.1970601622513;
                5.8912482337223, 5.1768065731908;
                5.8734526827909, 5.1903254727454;
                5.8130684715509, 5.2100875782421;
                5.7526842603108, 5.2122833677417;
                5.6846147858221, 5.2309475784886;
                5.6165453113333 5.2561991577345;
                5.5847063635886, 5.2496117892356;
                5.5133432048504, 5.2561991577345;
                5.4661337306082, 5.2759612632312;
                5.3980642561195, 5.2781570527308;
                5.3256032026314, 5.2847444212297;
                5.3080368866343, 5.2869402107294;
                5.2443589911449, 5.2902338949788;
                5.2, 5.3;
                5.146646358411, 5.2781570527308;
                5.0555210941761, 5.2561991577345;
                4.9841579354379, 5.2309475784886;
                4.9457316191942, 5.2210665257403;
                4.8852336807307, 5.1985972064638;
                4.8335441130597, 5.1720140002329;
                4.7818545453886, 5.1454307940021;


                4.7464102704142, 5.1026022950747;
                4.7271248342082, 5.077862205126;
                4.7141044998283, 4.9606791957071;
                4.7048042609856, 4.8583765684367;
                4.6955040221428, 4.7356134157122;
                4.6924011591258, 4.6220493912021;
                4.6924011591258, 4.5055069153312;
                4.7001706575172, 4.3941441050545;
                4.7338384838799, 4.2128558092553;
                4.7441978150684, 4.1299811597471;
                4.7571469790541, 4.028977680659;
                4.7856351398225, 3.9253843687737;
                4.8, 3.8;
                4.8529707925479, 3.5861162723495;
                4.8840487861135, 3.4566246324929;
                5.5703544773534, 3.5058314556384;
                5.6, 3.6;
                5.7024359500071, 3.6456824266835;
                5.7900193864191, 3.6998334760781;


                5.8818407310447, 3.7233774105975;
                5.9548269280548, 3.7516301320207;
                6.0348763054207, 3.7634020992804;
                6.1196344696904, 3.7586933123765;
                6.1879118797966, 3.7634020992804;
                6.2749930403341, 3.8102075254498;
                6.3435173120449, 3.7776584963871;
                6.3897711954497, 3.7553881080811;
                6.4565823603678, 3.7228390790184;
                6.5254967390313, 3.6808476750428;
                6.5686497778146, 3.6476530298249;
                6.6, 3.6;
                6.6682337134684, 3.5845832039108;
                6.6350390682504, 3.518193913475;
                6.5885665649454, 3.4684019456481;
                6.5122188809441, 3.4318878359084;
                6.4325517324211, 3.4086515842559;
                6.3628429774635, 3.3887347971251;
                6.2765368998969, 3.3721374745162;
                6.2101476094611, 3.3522206873854;
                6.1039247447638, 3.358859616429;
                6.0375354543279, 3.3555401519072;
                5.9578683058049, 3.3621790809508;
                5.8748816927601, 3.3688180099944;

                5.8, 3.4;
                5.7122279311923, 3.438526764952;
                5.6425191762347, 3.4949576618225;
                5.7553809699756, 3.5580274877365;
                5.8881595508473, 3.5679858813019;
                6.00434080911, 3.5646664167801;
                6.1138831383291, 3.5646664167801;
                6.2201060030265, 3.5679858813019;
                6.3329677967674, 3.5845832039108;
                6.4491490550301, 3.5845832039108;
                6.5520524552056, 3.5746248103455;
                6.6101997202356, 3.5464923715859;

];

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.1;
controller.DesiredLinearVelocity = 0.3;
controller.MaxAngularVelocity = 20;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    %waitfor(r);
end